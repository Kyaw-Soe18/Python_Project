<div class="container-fluid">
    <form id="class-form"  action="">
        {% csrf_token %}
        <input type="hidden" name="id" value="{{ class.id|default:'' }}">

        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label for="assigned_faculty" class="control-label">Assigned Teacher</label>
                    <select name="assigned_faculty" id="assigned_faculty" class="form-select rounded-0 select2" required>
                        <option value="">Select Faculty</option>
                        {% for f in faculties %}
                            <option value="{{ f.id }}" {% if class.assigned_faculty and class.assigned_faculty.id == f.id %}selected{% endif %}>
                                {{ f.user.first_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group mb-3">
                    <label for="name" class="control-label">Subject</label>
                    <input type="text" name="name" id="name" class="form-control rounded-0" value="{{ class.name|default:'' }}" required>
                </div>

                <div class="form-group mb-3">
                    <label for="level" class="control-label">Semester</label>
                    <input type="text" name="level" id="level" class="form-control rounded-0" value="{{ class.level|default:'' }}" required>
                </div>

                <div class="form-group mb-3">
                    <label for="school_year" class="control-label">School Year</label>
                    <input type="text" name="school_year" id="school_year" class="form-control rounded-0" value="{{ class.school_year|default:'' }}" required>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label for="course" class="control-label">Course</label>
                    <select name="course" id="course" class="form-select rounded-0 select2" required>
                        <option value="">Select Course</option>
                        {% for c in courses %}
                            <option value="{{ c.id }}" {% if class.course and class.course.id == c.id %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group mb-3">
                    <label for="section" class="control-label">Section</label>
                    <select name="section" id="section" class="form-select rounded-0 select2" required>
                        <option value="">Select Section</option>
                        {% if class.section %}
                            <option value="{{ class.section.id }}" selected>{{ class.section.name }}</option>
                        {% endif %}
                    </select>
                </div>
            </div>
        </div>


    </form>
</div>

<script>
$(function() {
    // Initialize Select2 inside modal
    $('#uni_modal').on('shown.bs.modal', function() {
        $('.select2').select2({
            placeholder: 'Please Select Here',
            width: '100%',
            dropdownParent: $('#uni_modal')
        });
    });

    // Load sections for course selection
    const $course = $('#course');
    const $section = $('#section');

    function loadSections(courseId, selectedSectionId = null) {
        $section.empty().append('<option value="">Loading...</option>');
        if (!courseId) {
            $section.empty().append('<option value="">Select Section</option>').prop('disabled', true);
            return;
        }

        $.ajax({
            url: "{% url 'ajax_load_sections' %}",
            data: { 'course_id': courseId },
            dataType: 'json',
            success: function(data) {
                $section.empty().append('<option value="">Select Section</option>');
                data.sections.forEach(function(sec) {
                    const isSelected = selectedSectionId && selectedSectionId == sec.id ? 'selected' : '';
                    $section.append(`<option value="${sec.id}" ${isSelected}>${sec.name}</option>`);
                });
                $section.prop('disabled', false);
            },
            error: function() {
                $section.empty().append('<option value="">Error loading sections</option>');
            }
        });
    }

    $course.on('change', function() {
        loadSections($(this).val());
    });

    {% if class and class.course %}
        loadSections("{{ class.course.id }}", "{{ class.section.id|default:'' }}");
    {% endif %}

    // AJAX form submit
    $('#class-form').submit(function(e) {
        e.preventDefault();
        var _this = $(this);
        $('.err-msg').remove();
        var el = $('<div>').addClass("alert alert-danger err-msg").hide();

        if (_this[0].checkValidity() === false) {
            _this[0].reportValidity();
            return false;
        }
        start_loader();
        $.ajax({
            url: "{% url 'save-class' %}",
            data: new FormData(this),
            cache: false,
            contentType: false,
            processData: false,
            method: 'POST',
            dataType: 'json',
            success: function(resp) {
                if (resp.status == 'success') {
                    location.reload();
                } else if (resp.status == 'failed' && resp.msg) {
                    el.html(resp.msg);
                } else {
                    el.text("An error occurred");
                }
                _this.prepend(el);
                el.show('slow');
                $("html, body, .modal").scrollTop(0);
                end_loader();
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error:", status, error);
                end_loader();
            }
        });
    });
});
</script>
